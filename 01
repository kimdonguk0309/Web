#!/bin/bash
set -e

echo "â–¶ï¸ WebSuperClusterIDE ì™„ì „ ìë™ ì„¤ì¹˜ ì‹œì‘..."

# 1. Node.js 20 ì„¤ì¹˜
if ! node -v | grep -q "v20"; then
    echo "ğŸ“¦ Node.js 20 ì„¤ì¹˜ ì¤‘..."
    curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
    sudo apt-get install -y nodejs
else
    echo "âœ… Node.js ì´ë¯¸ ì„¤ì¹˜ë¨: $(node -v)"
fi

# 2. npm ìµœì‹  ë²„ì „ìœ¼ë¡œ ì—…ê·¸ë ˆì´ë“œ
echo "â¬†ï¸ npm ìµœì‹  ë²„ì „ìœ¼ë¡œ ì—…ë°ì´íŠ¸..."
sudo npm install -g npm

# 3. ê¸°ì¡´ frontend ì œê±°
echo "ğŸ§¹ ê¸°ì¡´ frontend í´ë” ì‚­ì œ ì¤‘..."
rm -rf frontend

# 4. Vite + React + TypeScript í”„ë¡œì íŠ¸ ìƒì„±
echo "âš™ï¸ í”„ë¡œì íŠ¸ ìƒì„± ì¤‘..."
npx create-vite frontend --template react-ts --force
cd frontend

# 5. íŒ¨í‚¤ì§€ ì„¤ì¹˜
echo "ğŸ“¦ íŒ¨í‚¤ì§€ ì„¤ì¹˜ ì¤‘..."
npm install

# 6. TailwindCSS + shadcn/ui ì„¤ì¹˜
echo "ğŸ¨ Tailwind & shadcn ì„¤ì¹˜ ì¤‘..."
npm install -D tailwindcss postcss autoprefixer
npx tailwindcss init -p
npm install class-variance-authority clsx tailwind-variants
npm install @radix-ui/react-icons

# 7. Tailwind ì„¤ì • ì¶”ê°€
cat > tailwind.config.ts <<EOF
import type { Config } from 'tailwindcss'

const config: Config = {
  content: ['./index.html', './src/**/*.{js,ts,jsx,tsx}'],
  theme: { extend: {} },
  plugins: [],
}
export default config
EOF

cat > src/index.css <<EOF
@tailwind base;
@tailwind components;
@tailwind utilities;
EOF

# 8. Dashboard.tsx ìƒì„±
mkdir -p src/components
cat > src/components/Dashboard.tsx <<EOF
import React, { useEffect, useState } from 'react'

const NUM_CPUS = 100;
const CPUBenchmark = () => {
  const [benchmarks, setBenchmarks] = useState<number[]>([]);

  useEffect(() => {
    const workers: Worker[] = [];
    const results: number[] = Array(NUM_CPUS).fill(0);
    let completed = 0;

    for (let i = 0; i < NUM_CPUS; i++) {
      const blob = new Blob([`
        onmessage = () => {
          const start = performance.now();
          let sum = 0;
          for (let i = 0; i < 1e7; i++) sum += i;
          const end = performance.now();
          postMessage(end - start);
        }
      `], { type: 'application/javascript' });

      const worker = new Worker(URL.createObjectURL(blob));
      worker.onmessage = e => {
        results[i] = e.data;
        completed++;
        if (completed === NUM_CPUS) setBenchmarks([...results]);
      };
      worker.postMessage(1);
      workers.push(worker);
    }

    return () => workers.forEach(w => w.terminate());
  }, []);

  return (
    <div className="grid grid-cols-4 gap-4 mt-8">
      {benchmarks.map((ms, i) => (
        <div key={i} className="bg-blue-100 p-2 rounded shadow text-sm">
          CPU {i}: {ms.toFixed(2)} ms
        </div>
      ))}
    </div>
  );
};

export default CPUBenchmark;
EOF

# 9. App.tsx ë®ì–´ì“°ê¸°
cat > src/App.tsx <<EOF
import React from 'react'
import './index.css'
import Dashboard from './components/Dashboard'

function App() {
  return (
    <div className="p-8 font-sans">
      <h1 className="text-3xl font-bold mb-4 text-center">âš™ï¸ WebSuperClusterIDE</h1>
      <p className="text-center text-gray-700">100ê°œ ê°€ìƒ WebAssembly CPU ë²¤ì¹˜ë§ˆí¬</p>
      <Dashboard />
    </div>
  )
}

export default App
EOF

# 10. ê°œë°œ ì„œë²„ ì‹¤í–‰
echo "ğŸš€ ê°œë°œ ì„œë²„ ì‹¤í–‰ ì¤‘..."
npm run dev -- --host &
sleep 3

echo ""
echo "âœ… ì„¤ì¹˜ ì™„ë£Œ! ì ‘ì† ì£¼ì†Œ:"
echo "ğŸŒ http://<ì„œë²„-IP>:5173"
